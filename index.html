<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–°–∫–ª–∞–¥ –ø–ª—ë–Ω–∫–∏</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 0;
      background: #f5f5f5;
      color: #222;
    }

    .container {
      max-width: 480px;
      margin: 0 auto;
      padding: 16px;
    }

    h1 {
      font-size: 20px;
      text-align: center;
      margin-bottom: 12px;
    }

    .card {
      background: #ffffff;
      border-radius: 14px;
      padding: 12px 14px;
      margin-bottom: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }

    label {
      display: block;
      font-size: 13px;
      margin-bottom: 4px;
      color: #555;
    }

    input, button {
      width: 100%;
      box-sizing: border-box;
      font-size: 16px;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid #ccc;
    }

    input {
      background: #fafafa;
    }

    button {
      margin-top: 8px;
      font-weight: 600;
      border: none;
      cursor: pointer;
    }

    .btn-primary {
      background: #007bff;
      color: #fff;
    }

    .btn-danger {
      background: #dc3545;
      color: #fff;
    }

    .btn-secondary {
      background: #e0e0e0;
      color: #333;
    }

    .btn-outline {
      background: #fff;
      border: 1px solid #007bff;
      color: #007bff;
    }

    .small-text {
      font-size: 12px;
      color: #777;
      margin-top: 4px;
    }

    .suggestions {
      margin-top: 6px;
      max-height: 220px;
      overflow-y: auto;
      border-radius: 10px;
      border: 1px solid #ddd;
      background: #fff;
    }

    .suggestion-item {
      padding: 8px 10px;
      border-bottom: 1px solid #f0f0f0;
      font-size: 13px;
    }

    .suggestion-item:last-child {
      border-bottom: none;
    }

    .suggestion-item strong {
      display: block;
      font-size: 14px;
    }

    .suggestion-item span {
      color: #666;
    }

    .suggestion-item:active {
      background: #f1f1f1;
    }

    .selected {
      font-size: 14px;
      line-height: 1.4;
    }

    .row {
      display: flex;
      gap: 8px;
      margin-top: 8px;
    }

    .row > div {
      flex: 1;
    }

    .status {
      font-size: 13px;
      margin-top: 6px;
      min-height: 18px;
    }

    .status.ok {
      color: #2e7d32;
    }

    .status.error {
      color: #c62828;
    }

    /* –°–∫–∞–Ω–µ—Ä */
    #scannerCard {
      padding: 10px 12px;
    }

    #scannerContainer {
      position: relative;
      width: 100%;
      height: 220px;
      background: #000;
      border-radius: 12px;
      overflow: hidden;
      margin-top: 8px;
    }

    #video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .scanner-overlay-line {
      position: absolute;
      top: 50%;
      left: 10%;
      right: 10%;
      height: 2px;
      transform: translateY(-50%);
      background: rgba(255, 0, 0, 0.8);
      box-shadow: 0 0 8px rgba(255,0,0,0.9);
    }

    .scanner-hint {
      font-size: 12px;
      color: #eee;
      position: absolute;
      bottom: 6px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.45);
      padding: 4px 8px;
      border-radius: 8px;
    }

    /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ */
    .modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.4);
      z-index: 999;
      align-items: center;
      justify-content: center;
    }

    .modal-content {
      background: #fff;
      border-radius: 16px;
      padding: 16px;
      max-width: 320px;
      width: 90%;
      box-shadow: 0 4px 16px rgba(0,0,0,0.25);
    }

    .modal-text {
      font-size: 14px;
      margin-bottom: 12px;
      white-space: pre-line;
    }

    .modal-buttons {
      display: flex;
      gap: 8px;
      margin-top: 4px;
    }

    .modal-buttons button {
      flex: 1;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>–°–∫–ª–∞–¥ –ø–ª—ë–Ω–∫–∏</h1>

    <!-- –ü–æ–∏—Å–∫ –ø–æ —à—Ç—Ä–∏—Ö–∫–æ–¥—É / –ø–æ—Å–ª–µ–¥–Ω–∏–º —Ü–∏—Ñ—Ä–∞–º -->
    <div class="card">
      <label for="barcodeInput">–®—Ç—Ä–∏—Ö–∫–æ–¥ (–º–æ–∂–Ω–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Ü–∏—Ñ—Ä—ã)</label>
      <input id="barcodeInput" type="tel" inputmode="numeric" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, 9012" />
      <div class="small-text">–ú–æ–∂–Ω–æ –≤–≤–æ–¥–∏—Ç—å –≤—Ä—É—á–Ω—É—é –∏–ª–∏ –æ—Ç—Å–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –∫–∞–º–µ—Ä–æ–π.</div>
      <button id="toggleScannerBtn" class="btn-outline">üì∑ –í–∫–ª—é—á–∏—Ç—å —Å–∫–∞–Ω–µ—Ä</button>
      <div id="suggestions" class="suggestions" style="display:none;"></div>
    </div>

    <!-- –°–∫–∞–Ω–µ—Ä —à—Ç—Ä–∏—Ö–∫–æ–¥–∞ -->
    <div class="card" id="scannerCard" style="display:none;">
      <div class="small-text">–ù–∞–≤–µ–¥–∏ –∫–∞–º–µ—Ä—É –Ω–∞ —à—Ç—Ä–∏—Ö–∫–æ–¥. –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Å–∫–∞–Ω–µ—Ä —Å–∞–º –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è.</div>
      <div id="scannerContainer">
        <video id="video" muted autoplay playsinline></video>
        <div class="scanner-overlay-line"></div>
        <div class="scanner-hint">–ù–∞–≤–µ–¥–∏ —à—Ç—Ä–∏—Ö–∫–æ–¥ –≤ –∫—Ä–∞—Å–Ω—É—é –ª–∏–Ω–∏—é</div>
      </div>
    </div>

    <!-- –í—ã–±—Ä–∞–Ω–Ω–∞—è –ø–ª—ë–Ω–∫–∞ -->
    <div class="card" id="selectedCard" style="display:none;">
      <div class="selected">
        <div><strong id="selName"></strong></div>
        <div>–®—Ç—Ä–∏—Ö–∫–æ–¥: <span id="selBarcode"></span></div>
        <div>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–∞ —Å–∫–ª–∞–¥–µ: <span id="selQty"></span></div>
      </div>

      <div class="row">
        <div>
          <button id="deleteOneBtn" class="btn-danger">–°–ø–∏—Å–∞—Ç—å 1 —à—Ç.</button>
        </div>
        <div>
          <input id="deleteQty" type="number" min="1" value="1" />
          <button id="deleteManyBtn" class="btn-secondary">–°–ø–∏—Å–∞—Ç—å N —à—Ç.</button>
        </div>
      </div>

      <div class="status" id="deleteStatus"></div>
    </div>

    <!-- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ / –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ -->
    <div class="card">
      <label for="addBarcode">–®—Ç—Ä–∏—Ö–∫–æ–¥</label>
      <input id="addBarcode" type="tel" inputmode="numeric" placeholder="–ü–æ–ª–Ω—ã–π —à—Ç—Ä–∏—Ö–∫–æ–¥" />

      <label for="addName" style="margin-top:8px;">–ù–∞–∑–≤–∞–Ω–∏–µ –ø–ª—ë–Ω–∫–∏</label>
      <input id="addName" type="text" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, Hydrogel iPhone 11" />

      <div class="row">
        <div>
          <label for="addQty">–ö–æ–ª-–≤–æ</label>
          <input id="addQty" type="number" min="1" value="1" />
        </div>
      </div>

      <button id="addBtn" class="btn-primary">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å / —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      <div class="small-text" id="addHint"></div>
      <div class="status" id="addStatus"></div>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª–∫–∞ –¥–ª—è —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ —à—Ç—Ä–∏—Ö–∫–æ–¥–∞ -->
  <div class="modal" id="existingModal">
    <div class="modal-content">
      <div class="modal-text" id="existingText"></div>
      <div class="modal-buttons">
        <button id="modalAdd1" class="btn-primary">+1</button>
        <button id="modalDel1" class="btn-danger">-1</button>
      </div>
      <button id="modalCancel" class="btn-secondary" style="margin-top:8px;">–û—Ç–º–µ–Ω–∞</button>
    </div>
  </div>

  <!-- ZXing –¥–ª—è —Å–∫–∞–Ω–µ—Ä–∞ —à—Ç—Ä–∏—Ö–∫–æ–¥–æ–≤ -->
  <script src="https://unpkg.com/@zxing/library@latest"></script>
  <script>
    // ==== –í–°–¢–ê–í–¨ –°–í–û–ô URL –ò–ó APPS SCRIPT ====
    const API_URL = 'https://script.google.com/macros/s/AKfycbzyqfhKdkYdF6uGV3lBsYN14wNHK_0h7FpSOzy4h7bUxYLQ0P58ysDxwipCOquOOhxilA/exec';

    const barcodeInput   = document.getElementById('barcodeInput');
    const suggestionsEl  = document.getElementById('suggestions');
    const selectedCard   = document.getElementById('selectedCard');
    const selName        = document.getElementById('selName');
    const selBarcode     = document.getElementById('selBarcode');
    const selQty         = document.getElementById('selQty');

    const deleteOneBtn   = document.getElementById('deleteOneBtn');
    const deleteManyBtn  = document.getElementById('deleteManyBtn');
    const deleteQtyInput = document.getElementById('deleteQty');
    const deleteStatus   = document.getElementById('deleteStatus');

    const addBarcode     = document.getElementById('addBarcode');
    const addName        = document.getElementById('addName');
    const addQty         = document.getElementById('addQty');
    const addBtn         = document.getElementById('addBtn');
    const addStatus      = document.getElementById('addStatus');
    const addHint        = document.getElementById('addHint');

    const toggleScannerBtn = document.getElementById('toggleScannerBtn');
    const scannerCard      = document.getElementById('scannerCard');

    const existingModal = document.getElementById('existingModal');
    const existingText  = document.getElementById('existingText');
    const modalAdd1     = document.getElementById('modalAdd1');
    const modalDel1     = document.getElementById('modalDel1');
    const modalCancel   = document.getElementById('modalCancel');

    let currentItem = null;
    let searchTimeout = null;
    let scannerActive = false;
    let codeReader = null;  // <= –æ–±—ä—è–≤–ª—è–µ–º –û–î–ò–ù —Ä–∞–∑

    /* ===== –ü–æ–∏—Å–∫ –ø–æ –≤–µ—Ä—Ö–Ω–µ–º—É –ø–æ–ª—é (action=search, —á–∞—Å—Ç—å —à—Ç—Ä–∏—Ö–∫–æ–¥–∞) ===== */
    barcodeInput.addEventListener('input', () => {
      const q = barcodeInput.value.trim();
      if (searchTimeout) clearTimeout(searchTimeout);
      if (!q) {
        suggestionsEl.style.display = 'none';
        suggestionsEl.innerHTML = '';
        selectedCard.style.display = 'none';
        currentItem = null;
        return;
      }
      searchTimeout = setTimeout(() => searchItems(q), 250);
    });

    function searchItems(query) {
      fetch(API_URL + '?action=search&query=' + encodeURIComponent(query))
        .then(r => r.json())
        .then(data => {
          const items = data.items || [];
          if (!items.length) {
            suggestionsEl.style.display = 'none';
            suggestionsEl.innerHTML = '';
            return;
          }

          suggestionsEl.innerHTML = '';
          items.forEach(item => {
            const div = document.createElement('div');
            div.className = 'suggestion-item';
            div.innerHTML = `
              <strong>${item.name}</strong>
              <span>–®–ö: ${item.barcode} ‚Ä¢ –û—Å—Ç–∞—Ç–æ–∫: ${item.quantity}</span>
            `;
            div.addEventListener('click', () => {
              selectItem(item);
            });
            suggestionsEl.appendChild(div);
          });
          suggestionsEl.style.display = 'block';
        })
        .catch(err => {
          console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ searchItems:', err);
        });
    }

    function selectItem(item) {
      currentItem = item;
      selName.textContent    = item.name;
      selBarcode.textContent = item.barcode;
      selQty.textContent     = item.quantity;
      selectedCard.style.display = 'block';
      addBarcode.value = item.barcode;
      addName.value    = item.name;
      deleteStatus.textContent = '';
      suggestionsEl.style.display = 'none';
    }

    function updateSelectedQty(newQty) {
      if (!currentItem) return;
      currentItem.quantity = newQty;
      selQty.textContent = newQty;
    }

    /* ===== –ë—ã—Å—Ç—Ä–æ–µ —Å–ø–∏—Å–∞–Ω–∏–µ —Å–Ω–∏–∑—É ===== */
    deleteOneBtn.addEventListener('click', () => {
      if (!currentItem) return;
      doDelete(currentItem.barcode, 1);
    });

    deleteManyBtn.addEventListener('click', () => {
      if (!currentItem) return;
      const qty = Number(deleteQtyInput.value || 1);
      if (qty <= 0) return;
      doDelete(currentItem.barcode, qty);
    });

    function doDelete(barcode, qty) {
      deleteStatus.textContent = `–°–ø–∏—Å—ã–≤–∞–µ–º ${qty} —à—Ç...`;
      deleteStatus.className = 'status';

      fetch(API_URL + '?action=delete&barcode=' + encodeURIComponent(barcode) + '&quantity=' + qty)
        .then(r => r.json())
        .then(data => {
          if (data.error) {
            deleteStatus.textContent = '–û—à–∏–±–∫–∞: ' + (data.message || data.error);
            deleteStatus.className = 'status error';
          } else {
            deleteStatus.textContent = `–°–ø–∏—Å–∞–Ω–æ ${qty} —à—Ç. –ù–æ–≤–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ: ${data.newQty}`;
            deleteStatus.className = 'status ok';
            updateSelectedQty(data.newQty);
          }
        })
        .catch(err => {
          console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–ø–∏—Å–∞–Ω–∏–∏:', err);
          deleteStatus.textContent = '–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–ø–∏—Å–∞–Ω–∏–∏';
          deleteStatus.className = 'status error';
        });
    }

    /* ===== –ö–Ω–æ–ø–∫–∞ "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å / —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å" (action=get) ===== */
    addBtn.addEventListener('click', () => {
      const barcode = addBarcode.value.trim();
      const name    = addName.value.trim();
      const qty     = Number(addQty.value || 1);

      addStatus.textContent = '';
      addStatus.className = 'status';
      addHint.textContent = '';

      if (!barcode) {
        addStatus.textContent = '–í–≤–µ–¥–∏—Ç–µ —à—Ç—Ä–∏—Ö–∫–æ–¥';
        addStatus.className = 'status error';
        return;
      }

      addStatus.textContent = '–ü—Ä–æ–≤–µ—Ä—è–µ–º —à—Ç—Ä–∏—Ö–∫–æ–¥ –≤ –±–∞–∑–µ...';
      addStatus.className = 'status';

      fetch(API_URL + '?action=get&barcode=' + encodeURIComponent(barcode))
        .then(r => r.json())
        .then(data => {
          if (data.error && data.error !== 'GET_ERROR' && data.error !== 'BAD_REQUEST') {
            addStatus.textContent = '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ' + (data.message || data.error);
            addStatus.className = 'status error';
            return;
          }

          const item = data.item || null;

          if (item) {
            // –®—Ç—Ä–∏—Ö–∫–æ–¥ –µ—Å—Ç—å –≤ –±–∞–∑–µ -> –ø–æ–ø–∞–ø +1 / -1
            addStatus.textContent = '';
            addHint.textContent = '';
            selectItem(item);
            showExistingModal(item);
          } else {
            // –ù–µ—Ç –≤ –±–∞–∑–µ -> –¥–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π (–µ—Å–ª–∏ –µ—Å—Ç—å name+qty)
            addStatus.textContent = '';
            if (!name || qty <= 0) {
              addHint.textContent = '–¢–∞–∫–æ–≥–æ —à—Ç—Ä–∏—Ö–∫–æ–¥–∞ –Ω–µ—Ç –≤ –±–∞–∑–µ. –í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏ —Å–Ω–æ–≤–∞ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä.';
              return;
            }
            doAdd(barcode, name, qty, () => {
              addHint.textContent = '–ù–æ–≤—ã–π —Ç–æ–≤–∞—Ä –¥–æ–±–∞–≤–ª–µ–Ω –≤ –±–∞–∑—É.';
            });
          }
        })
        .catch(err => {
          console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —à—Ç—Ä–∏—Ö–∫–æ–¥–∞:', err);
          addStatus.textContent = '–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —à—Ç—Ä–∏—Ö–∫–æ–¥. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.';
          addStatus.className = 'status error';
        });
    });

    function doAdd(barcode, name, qty, onDone) {
      addStatus.textContent = '–°–æ—Ö—Ä–∞–Ω—è–µ–º...';
      addStatus.className = 'status';

      const url = API_URL
        + '?action=add'
        + '&barcode=' + encodeURIComponent(barcode)
        + '&name='    + encodeURIComponent(name)
        + '&quantity=' + qty;

      fetch(url)
        .then(r => r.json())
        .then(data => {
          if (data.error) {
            addStatus.textContent = '–û—à–∏–±–∫–∞: ' + (data.message || data.error);
            addStatus.className = 'status error';
          } else {
            addStatus.textContent = '–£—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ';
            addStatus.className = 'status ok';

            if (currentItem && currentItem.barcode === barcode) {
              searchItems(barcode);
            }
            if (typeof onDone === 'function') onDone();
          }
        })
        .catch(err => {
          console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏:', err);
          addStatus.textContent = '–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏';
          addStatus.className = 'status error';
        });
    }

    /* ===== –ú–æ–¥–∞–ª–∫–∞ +1 / -1 ===== */
    let modalCurrentItem = null;

    function showExistingModal(item) {
      modalCurrentItem = item;
      existingText.textContent =
        `–í –±–∞–∑–µ ${item.quantity} —à—Ç. —Ç–æ–≤–∞—Ä–∞:\n¬´${item.name}¬ª.\n–ß—Ç–æ –≤—ã —Ö–æ—Ç–∏—Ç–µ —Å–¥–µ–ª–∞—Ç—å?`;
      existingModal.style.display = 'flex';
    }

    function closeExistingModal() {
      existingModal.style.display = 'none';
      modalCurrentItem = null;
    }

    modalCancel.addEventListener('click', () => {
      closeExistingModal();
    });

    modalAdd1.addEventListener('click', () => {
      if (!modalCurrentItem) return;
      doAdd(modalCurrentItem.barcode, modalCurrentItem.name, 1, () => {
        closeExistingModal();
        searchItems(modalCurrentItem.barcode);
      });
    });

    modalDel1.addEventListener('click', () => {
      if (!modalCurrentItem) return;

      deleteStatus.textContent = '–°–ø–∏—Å—ã–≤–∞–µ–º 1 —à—Ç...';
      deleteStatus.className = 'status';

      fetch(API_URL + '?action=delete&barcode=' + encodeURIComponent(modalCurrentItem.barcode) + '&quantity=1')
        .then(r => r.json())
        .then(data => {
          if (data.error) {
            deleteStatus.textContent = '–û—à–∏–±–∫–∞: ' + (data.message || data.error);
            deleteStatus.className = 'status error';
          } else {
            deleteStatus.textContent = `–°–ø–∏—Å–∞–Ω–æ 1 —à—Ç. –ù–æ–≤–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ: ${data.newQty}`;
            deleteStatus.className = 'status ok';
            updateSelectedQty(data.newQty);
          }
          closeExistingModal();
        })
        .catch(err => {
          console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–ø–∏—Å–∞–Ω–∏–∏ –∏–∑ –º–æ–¥–∞–ª–∫–∏:', err);
          deleteStatus.textContent = '–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–ø–∏—Å–∞–Ω–∏–∏';
          deleteStatus.className = 'status error';
          closeExistingModal();
        });
    });

    existingModal.addEventListener('click', (e) => {
      if (e.target === existingModal) {
        closeExistingModal();
      }
    });

    /* ===== –°–∫–∞–Ω–µ—Ä –Ω–∞ ZXing ===== */
    toggleScannerBtn.addEventListener('click', () => {
      if (scannerActive) {
        stopScanner();
      } else {
        startScanner();
      }
    });

    function startScanner() {
      if (scannerActive) return;

      scannerCard.style.display = 'block';
      toggleScannerBtn.textContent = '‚úñ –í—ã–∫–ª—é—á–∏—Ç—å —Å–∫–∞–Ω–µ—Ä';

      if (!codeReader) {
        codeReader = new ZXing.BrowserMultiFormatReader();
      }

      codeReader
        .decodeFromVideoDevice(
          null,
          'video',
          (result, err) => {
            if (result) {
              const code = result.getText();
              stopScanner();

              barcodeInput.value = code;
              addBarcode.value   = code;

              addHint.textContent = '';
              addStatus.textContent = '';

              searchItems(code);
            }
            // err (NotFoundException –∏ —Ç.–ø.) ZXing –∫–∏–¥–∞–µ—Ç –ø–æ—Å—Ç–æ—è–Ω–Ω–æ ‚Äì –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º
          }
        )
        .then(() => {
          scannerActive = true;
        })
        .catch(err => {
          console.error('–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ —Å–∫–∞–Ω–µ—Ä–∞:', err);
          alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –∫–∞–º–µ—Ä—É. –†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ –∏ –æ—Ç–∫—Ä–æ–π—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø–æ HTTPS.');
          scannerCard.style.display = 'none';
          toggleScannerBtn.textContent = 'üì∑ –í–∫–ª—é—á–∏—Ç—å —Å–∫–∞–Ω–µ—Ä';
          scannerActive = false;
        });
    }

    function stopScanner() {
      if (!scannerActive) return;
      if (codeReader) {
        codeReader.reset();
      }
      scannerActive = false;
      scannerCard.style.display = 'none';
      toggleScannerBtn.textContent = 'üì∑ –í–∫–ª—é—á–∏—Ç—å —Å–∫–∞–Ω–µ—Ä';
    }
  </script>
</body>
</html>
