<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>moscrm ‚Äî –°–∫–ª–∞–¥ –ø–ª—ë–Ω–∫–∏</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 0;
      background: #f5f5f5;
      color: #222;
    }
    .container { max-width: 520px; margin: 0 auto; padding: 16px; }
    h1 { font-size: 20px; text-align: center; margin: 0 0 12px; }

    .card {
      background: #ffffff;
      border-radius: 14px;
      padding: 12px 14px;
      margin-bottom: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }

    label { display: block; font-size: 13px; margin-bottom: 4px; color: #555; }

    input, button {
      width: 100%;
      box-sizing: border-box;
      font-size: 16px;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid #ccc;
    }

    input { background: #fafafa; }
    button { margin-top: 8px; font-weight: 700; border: none; cursor: pointer; }

    .btn-primary { background: #007bff; color: #fff; }
    .btn-danger  { background: #dc3545; color: #fff; }
    .btn-secondary { background: #e0e0e0; color: #333; }
    .btn-outline { background: #fff; border: 1px solid #007bff; color: #007bff; }

    .small-text { font-size: 12px; color: #777; margin-top: 6px; line-height: 1.35; }

    .suggestions {
      margin-top: 8px;
      max-height: 240px;
      overflow-y: auto;
      border-radius: 10px;
      border: 1px solid #ddd;
      background: #fff;
    }

    .suggestion-item {
      padding: 10px 10px;
      border-bottom: 1px solid #f0f0f0;
      font-size: 13px;
    }
    .suggestion-item:last-child { border-bottom: none; }
    .suggestion-item strong { display: block; font-size: 14px; margin-bottom: 2px; }
    .suggestion-item span { color: #666; }
    .suggestion-item:active { background: #f1f1f1; }

    .status { font-size: 13px; margin-top: 8px; min-height: 18px; }
    .status.ok { color: #2e7d32; }
    .status.error { color: #c62828; }

    /* Scanner */
    #scannerCard { padding: 12px 14px; }
    #scannerContainer {
      position: relative;
      width: 100%;
      height: 240px;
      background: #000;
      border-radius: 12px;
      overflow: hidden;
      margin-top: 10px;
    }
    #video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .scanner-overlay-line {
      position: absolute;
      top: 50%;
      left: 8%;
      right: 8%;
      height: 2px;
      transform: translateY(-50%);
      background: rgba(255, 0, 0, 0.85);
      box-shadow: 0 0 10px rgba(255,0,0,0.9);
    }
    .scanner-hint {
      font-size: 12px;
      color: #eee;
      position: absolute;
      bottom: 8px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.45);
      padding: 5px 10px;
      border-radius: 10px;
      text-align: center;
      max-width: 90%;
    }
    .scanner-toolbar {
      display: flex;
      gap: 8px;
      margin-top: 8px;
    }
    .scanner-toolbar button {
      margin-top: 0;
    }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.4);
      z-index: 999;
      align-items: center;
      justify-content: center;
      padding: 14px;
    }
    .modal-content {
      background: #fff;
      border-radius: 16px;
      padding: 16px;
      max-width: 360px;
      width: 100%;
      box-shadow: 0 4px 18px rgba(0,0,0,0.25);
    }
    .modal-text {
      font-size: 14px;
      margin-bottom: 12px;
      white-space: pre-line;
      line-height: 1.35;
    }
    .modal-buttons {
      display: flex;
      gap: 10px;
    }
    .modal-buttons button { flex: 1; }
  </style>
</head>
<body>
  <div class="container">
    <h1>moscrm ‚Äî –°–∫–ª–∞–¥ –ø–ª—ë–Ω–∫–∏</h1>

    <!-- Search / scan -->
    <div class="card">
      <label for="barcodeInput">–®—Ç—Ä–∏—Ö–∫–æ–¥ (–º–æ–∂–Ω–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Ü–∏—Ñ—Ä—ã)</label>
      <input id="barcodeInput" type="tel" inputmode="numeric" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, 35924" />
      <div class="small-text">–í–≤–æ–¥–∏ –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Ü–∏—Ñ—Ä—ã ‚Äî –ø–æ—è–≤–∏—Ç—Å—è —Å–ø–∏—Å–æ–∫. –ò–ª–∏ –Ω–∞–∂–º–∏ ¬´–°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å¬ª.</div>

      <button id="toggleScannerBtn" class="btn-outline">üì∑ –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å</button>
      <div id="suggestions" class="suggestions" style="display:none;"></div>
    </div>

    <!-- Scanner -->
    <div class="card" id="scannerCard" style="display:none;">
      <div class="small-text">
        –ù–∞ Android (Huawei/Samsung) –∫–∞–º–µ—Ä–∞ –º–æ–∂–µ—Ç –≤–∫–ª—é—á–∞—Ç—å—Å—è –Ω–µ —Ç–∞. –ù–∞–∂–º–∏ <b>üîÅ –°–º–µ–Ω–∏—Ç—å –∫–∞–º–µ—Ä—É</b>, –µ—Å–ª–∏ —Å—á–∏—Ç—ã–≤–∞–µ—Ç –ø–ª–æ—Ö–æ.
      </div>

      <div class="scanner-toolbar">
        <button id="switchCameraBtn" class="btn-secondary">üîÅ –°–º–µ–Ω–∏—Ç—å –∫–∞–º–µ—Ä—É</button>
        <button id="stopScannerBtn" class="btn-secondary">‚úñ –ó–∞–∫—Ä—ã—Ç—å</button>
      </div>

      <div id="scannerContainer">
        <video id="video" muted autoplay playsinline></video>
        <div class="scanner-overlay-line"></div>
        <div class="scanner-hint" id="scannerHint">–ù–∞–≤–µ–¥–∏ —à—Ç—Ä–∏—Ö–∫–æ–¥ –Ω–∞ –∫—Ä–∞—Å–Ω—É—é –ª–∏–Ω–∏—é</div>
      </div>

      <div class="status" id="scannerStatus"></div>
    </div>

    <!-- Add / check -->
    <div class="card">
      <label for="addBarcode">–®—Ç—Ä–∏—Ö–∫–æ–¥</label>
      <input id="addBarcode" type="tel" inputmode="numeric" placeholder="–ü–æ–ª–Ω—ã–π —à—Ç—Ä–∏—Ö–∫–æ–¥" />

      <label for="addName" style="margin-top:8px;">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
      <input id="addName" type="text" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, –ì–∏–¥—Ä–æ–≥–µ–ª–µ–≤–∞—è –ø–ª—ë–Ω–∫–∞..." />

      <label for="addQty" style="margin-top:8px;">–ö–æ–ª-–≤–æ</label>
      <input id="addQty" type="number" min="1" value="1" />

      <button id="addBtn" class="btn-primary">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å / —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      <div class="small-text" id="addHint"></div>
      <div class="status" id="addStatus"></div>
    </div>
  </div>

  <!-- Popup for existing item -->
  <div class="modal" id="existingModal">
    <div class="modal-content">
      <div class="modal-text" id="existingText"></div>
      <div class="modal-buttons">
        <button id="modalAdd1" class="btn-primary">+1</button>
        <button id="modalDel1" class="btn-danger">-1</button>
      </div>
      <button id="modalCancel" class="btn-secondary" style="margin-top:10px;">–û—Ç–º–µ–Ω–∞</button>
    </div>
  </div>

  <script src="https://unpkg.com/@zxing/library@latest"></script>
  <script>
    // –í—Å—Ç–∞–≤—å —Å—é–¥–∞ URL Apps Script Web App (/exec)
    const API_URL = 'https://script.google.com/macros/s/AKfycbyo6uual9eT8NbBZFPFPyj8k6lpCuW2n95qMZQx_L4VV4i5AHlT7z8vb6VsvY1TPDRYvA/exec';

    const barcodeInput = document.getElementById('barcodeInput');
    const suggestionsEl = document.getElementById('suggestions');

    const addBarcode = document.getElementById('addBarcode');
    const addName = document.getElementById('addName');
    const addQty = document.getElementById('addQty');
    const addBtn = document.getElementById('addBtn');
    const addHint = document.getElementById('addHint');
    const addStatus = document.getElementById('addStatus');

    const toggleScannerBtn = document.getElementById('toggleScannerBtn');
    const scannerCard = document.getElementById('scannerCard');
    const switchCameraBtn = document.getElementById('switchCameraBtn');
    const stopScannerBtn = document.getElementById('stopScannerBtn');
    const scannerStatus = document.getElementById('scannerStatus');
    const scannerHint = document.getElementById('scannerHint');
    const videoEl = document.getElementById('video');

    const existingModal = document.getElementById('existingModal');
    const existingText = document.getElementById('existingText');
    const modalAdd1 = document.getElementById('modalAdd1');
    const modalDel1 = document.getElementById('modalDel1');
    const modalCancel = document.getElementById('modalCancel');

    let searchTimeout = null;
    let modalCurrentItem = null;

    // ===== JSONP (–æ–±—Ö–æ–¥ CORS) =====
    function jsonpCall(params) {
      return new Promise((resolve, reject) => {
        const cb = 'jsonp_cb_' + Date.now() + '_' + Math.random().toString(16).slice(2);
        params = Object.assign({}, params, { callback: cb });

        const query = Object.keys(params)
          .map(k => encodeURIComponent(k) + '=' + encodeURIComponent(params[k]))
          .join('&');

        const script = document.createElement('script');
        script.src = API_URL + '?' + query;
        script.async = true;

        const timeout = setTimeout(() => {
          cleanup();
          reject(new Error('JSONP timeout'));
        }, 10000);

        function cleanup() {
          if (script.parentNode) script.parentNode.removeChild(script);
          clearTimeout(timeout);
          delete window[cb];
        }

        window[cb] = (data) => { cleanup(); resolve(data); };
        script.onerror = () => { cleanup(); reject(new Error('JSONP script error')); };

        document.body.appendChild(script);
      });
    }

    // ===== Search suggestions (fast) =====
    barcodeInput.addEventListener('input', () => {
      const q = barcodeInput.value.trim();
      if (searchTimeout) clearTimeout(searchTimeout);
      if (!q) {
        suggestionsEl.style.display = 'none';
        suggestionsEl.innerHTML = '';
        return;
      }
      searchTimeout = setTimeout(() => searchItems(q), 80);
    });

    function searchItems(query) {
      jsonpCall({ action: 'list', query })
        .then(data => {
          const items = data.items || [];
          if (!items.length) {
            suggestionsEl.style.display = 'none';
            suggestionsEl.innerHTML = '';
            return;
          }
          suggestionsEl.innerHTML = '';
          items.forEach(item => {
            const div = document.createElement('div');
            div.className = 'suggestion-item';
            div.innerHTML = `
              <strong>${escapeHtml(item.name)}</strong>
              <span>–®–ö: ${escapeHtml(String(item.barcode))} ‚Ä¢ –û—Å—Ç–∞—Ç–æ–∫: ${Number(item.quantity||0)}</span>
            `;
            div.addEventListener('click', () => {
              addBarcode.value = String(item.barcode);
              addName.value = String(item.name || '');
              addHint.textContent = '';
              suggestionsEl.style.display = 'none';
            });
            suggestionsEl.appendChild(div);
          });
          suggestionsEl.style.display = 'block';
        })
        .catch(err => console.error('searchItems error:', err));
    }

    function escapeHtml(s) {
      return String(s).replace(/[&<>"']/g, m => ({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
      })[m]);
    }

    // ===== Check/Save button =====
    addBtn.addEventListener('click', () => {
      const barcode = addBarcode.value.trim();
      const name = addName.value.trim();
      const qty = Number(addQty.value || 1);

      addStatus.textContent = '';
      addStatus.className = 'status';
      addHint.textContent = '';

      if (!barcode) {
        addStatus.textContent = '–í–≤–µ–¥–∏—Ç–µ —à—Ç—Ä–∏—Ö–∫–æ–¥';
        addStatus.className = 'status error';
        return;
      }

      addStatus.textContent = '–ü—Ä–æ–≤–µ—Ä—è–µ–º —à—Ç—Ä–∏—Ö–∫–æ–¥ –≤ –±–∞–∑–µ...';

      jsonpCall({ action: 'list', query: barcode })
        .then(data => {
          const items = Array.isArray(data.items) ? data.items : [];
          const exact = items.find(i => String(i.barcode) === barcode);

          if (exact) {
            addStatus.textContent = '';
            showExistingModal(exact);
          } else {
            handleAddNew(barcode, name, qty);
          }
        })
        .catch(err => {
          console.error('check barcode error:', err);
          handleAddNew(barcode, name, qty, true);
        });
    });

    function handleAddNew(barcode, name, qty, fromError=false) {
      addStatus.textContent = '';
      addStatus.className = 'status';
      if (!name || qty <= 0) {
        addHint.textContent = fromError
          ? '–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –±–∞–∑—É. –í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –µ—â—ë —Ä–∞–∑, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä.'
          : '–¢–∞–∫–æ–≥–æ —à—Ç—Ä–∏—Ö–∫–æ–¥–∞ –Ω–µ—Ç –≤ –±–∞–∑–µ. –í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –µ—â—ë —Ä–∞–∑, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä.';
        return;
      }
      doAdd(barcode, name, qty, (data) => {
        const newQty = (data && typeof data.newQty === 'number') ? data.newQty : qty;
        addStatus.textContent = `–î–æ–±–∞–≤–ª–µ–Ω–æ. –°–µ–π—á–∞—Å –Ω–∞ —Å–∫–ª–∞–¥–µ: ${newQty}`;
        addStatus.className = 'status ok';
      });
    }

    function doAdd(barcode, name, qty, onDone) {
      addStatus.textContent = '–°–æ—Ö—Ä–∞–Ω—è–µ–º...';
      addStatus.className = 'status';

      jsonpCall({ action: 'add', barcode, name, quantity: qty })
        .then(data => {
          if (data.error) {
            addStatus.textContent = '–û—à–∏–±–∫–∞: ' + (data.message || data.error);
            addStatus.className = 'status error';
          } else {
            if (typeof onDone === 'function') onDone(data);
          }
        })
        .catch(err => {
          console.error('add error:', err);
          addStatus.textContent = '–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏';
          addStatus.className = 'status error';
        });
    }

    function doDelete(barcode, qty, onDone) {
      addStatus.textContent = `–°–ø–∏—Å—ã–≤–∞–µ–º ${qty}...`;
      addStatus.className = 'status';

      jsonpCall({ action: 'delete', barcode, quantity: qty })
        .then(data => {
          if (data.error) {
            addStatus.textContent = '–û—à–∏–±–∫–∞: ' + (data.message || data.error);
            addStatus.className = 'status error';
          } else {
            if (typeof onDone === 'function') onDone(data);
          }
        })
        .catch(err => {
          console.error('delete error:', err);
          addStatus.textContent = '–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–ø–∏—Å–∞–Ω–∏–∏';
          addStatus.className = 'status error';
        });
    }

    // ===== Popup existing =====
    function showExistingModal(item) {
      modalCurrentItem = item;
      existingText.textContent =
        `–í –±–∞–∑–µ ${Number(item.quantity || 0)} —à—Ç. —Ç–æ–≤–∞—Ä–∞:\n¬´${String(item.name || '')}¬ª.\n–ß—Ç–æ –≤—ã —Ö–æ—Ç–∏—Ç–µ —Å–¥–µ–ª–∞—Ç—å?`;
      existingModal.style.display = 'flex';
    }

    function closeExistingModal() {
      existingModal.style.display = 'none';
      modalCurrentItem = null;
    }

    modalCancel.addEventListener('click', closeExistingModal);
    existingModal.addEventListener('click', (e) => {
      if (e.target === existingModal) closeExistingModal();
    });

    modalAdd1.addEventListener('click', () => {
      if (!modalCurrentItem) return;
      const code = String(modalCurrentItem.barcode);
      const name = String(modalCurrentItem.name || '');
      const oldQty = Number(modalCurrentItem.quantity || 0);

      doAdd(code, name, 1, (data) => {
        closeExistingModal();
        const newQty = (data && typeof data.newQty === 'number') ? data.newQty : (oldQty + 1);
        addStatus.textContent = `–î–æ–±–∞–≤–ª–µ–Ω–æ 1 —à—Ç. –ù–æ–≤–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ: ${newQty}`;
        addStatus.className = 'status ok';
      });
    });

    modalDel1.addEventListener('click', () => {
      if (!modalCurrentItem) return;
      const code = String(modalCurrentItem.barcode);
      const oldQty = Number(modalCurrentItem.quantity || 0);

      doDelete(code, 1, (data) => {
        closeExistingModal();
        const newQty = (data && typeof data.newQty === 'number') ? data.newQty : Math.max(oldQty - 1, 0);
        addStatus.textContent = `–°–ø–∏—Å–∞–Ω–æ 1 —à—Ç. –ù–æ–≤–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ: ${newQty}`;
        addStatus.className = 'status ok';
      });
    });

    // ===== Scanner (Huawei-friendly re-invented) =====
    // –ì–ª–∞–≤–Ω–∞—è –∏–¥–µ—è: –ù–ï deviceId, –∞ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ getUserMedia —Å —Ä–∞–∑–Ω—ã–º–∏ constraints.
    // Huawei —á–∞—Å—Ç–æ –Ω–µ –¥–∞—ë—Ç —Å–ø–∏—Å–æ–∫ –∫–∞–º–µ—Ä –∏ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç deviceId.
    const constraintsVariants = [
      // 0 ‚Äî —Å—Ç—Ä–æ–≥–∏–π environment (–Ω–∞ –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –∞–Ω–¥—Ä–æ–∏–¥–∞—Ö –º–æ–∂–µ—Ç –ø–∞–¥–∞—Ç—å)
      { audio: false, video: { facingMode: { exact: "environment" } } },

      // 1 ‚Äî –º—è–≥–∫–∏–π environment
      { audio: false, video: { facingMode: "environment" } },

      // 2 ‚Äî –ø—Ä–æ—Å—Ç–æ video:true (–ø—É—Å—Ç—å —Å–∏—Å—Ç–µ–º–∞ –≤—ã–±–µ—Ä–µ—Ç)
      { audio: false, video: true }
    ];

    // ‚Äú—Ä–µ–∂–∏–º –∫–∞–º–µ—Ä—ã‚Äù: –º—ã —Ü–∏–∫–ª–∏–º 0‚Üí1‚Üí2‚Üí0 –ø–æ –∫–Ω–æ–ø–∫–µ üîÅ
    let cameraMode = 0;

    let codeReader = null;
    let scannerRunning = false;

    toggleScannerBtn.addEventListener('click', () => {
      if (scannerRunning) stopScanner();
      else startScanner();
    });

    stopScannerBtn.addEventListener('click', () => stopScanner());

    switchCameraBtn.addEventListener('click', () => {
      cameraMode = (cameraMode + 1) % constraintsVariants.length;
      if (scannerRunning) {
        scannerStatus.textContent = '–ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –∫–∞–º–µ—Ä—É...';
        scannerStatus.className = 'status';
        restartScanner();
      }
    });

    async function startScanner() {
      scannerCard.style.display = 'block';
      toggleScannerBtn.textContent = '‚úñ –ó–∞–∫—Ä—ã—Ç—å —Å–∫–∞–Ω–µ—Ä';

      scannerStatus.textContent = '–ó–∞–ø—É—Å–∫–∞–µ–º –∫–∞–º–µ—Ä—É...';
      scannerStatus.className = 'status';

      if (!codeReader) codeReader = new ZXing.BrowserMultiFormatReader();

      // –í–∞–∂–Ω–æ: –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ –ø—Ä–æ–±—É–µ–º —Ç–µ–∫—É—â–∏–π cameraMode,
      // –µ—Å–ª–∏ –Ω–µ —Å—Ç–∞—Ä—Ç—É–µ—Ç ‚Äî –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–±–µ—Ä—ë–º –≤–∞—Ä–∏–∞–Ω—Ç—ã.
      await restartScanner(true);
    }

    async function restartScanner(autoFallback=false) {
      // reset ZXing (–æ—Å—Ç–∞–Ω–æ–≤–∏—Ç —Ç—Ä–µ–∫–∏, –µ—Å–ª–∏ –æ–Ω–∏ –±—ã–ª–∏)
      try { if (codeReader) codeReader.reset(); } catch (_) {}

      const tryOrder = autoFallback
        ? [cameraMode, 0, 1, 2].filter((v, i, a) => a.indexOf(v) === i) // —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ
        : [cameraMode];

      for (const mode of tryOrder) {
        try {
          scannerHint.textContent = `–†–µ–∂–∏–º –∫–∞–º–µ—Ä—ã: ${mode + 1} / ${constraintsVariants.length} (üîÅ –µ—Å–ª–∏ –ø–ª–æ—Ö–æ —á–∏—Ç–∞–µ—Ç)`;
          await codeReader.decodeFromConstraints(
            constraintsVariants[mode],
            videoEl,
            (result, err) => {
              if (result) {
                const code = result.getText();
                stopScanner(); // —Å—Ä–∞–∑—É –∑–∞–∫—Ä—ã–≤–∞–µ–º

                barcodeInput.value = code;
                addBarcode.value = code;

                addHint.textContent = '';
                addStatus.textContent = '';
                addStatus.className = 'status';

                // –±—ã—Å—Ç—Ä—ã–π –ø–æ–∏—Å–∫ –ø–æ –ø–æ–ª–Ω–æ–º—É –∫–æ–¥—É
                searchItems(code);
              }
            }
          );

          // –µ—Å–ª–∏ decodeFromConstraints –Ω–µ –±—Ä–æ—Å–∏–ª –æ—à–∏–±–∫—É ‚Äî –∑–Ω–∞—á–∏—Ç –∫–∞–º–µ—Ä–∞ —Å—Ç–∞—Ä—Ç–æ–≤–∞–ª–∞
          cameraMode = mode;
          scannerRunning = true;
          scannerStatus.textContent = '–ö–∞–º–µ—Ä–∞ –≤–∫–ª—é—á–µ–Ω–∞. –ù–∞–≤–µ–¥–∏ —à—Ç—Ä–∏—Ö–∫–æ–¥ –Ω–∞ –ª–∏–Ω–∏—é.';
          scannerStatus.className = 'status ok';
          return;

        } catch (err) {
          console.warn('Scanner start failed (mode=' + mode + '):', err);
          // –ø—Ä–æ–±—É–µ–º —Å–ª–µ–¥—É—é—â–∏–π
        }
      }

      scannerRunning = false;
      scannerStatus.textContent = '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –∫–∞–º–µ—Ä—É. –ü—Ä–æ–≤–µ—Ä—å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –∏ HTTPS.';
      scannerStatus.className = 'status error';
    }

    function stopScanner() {
      try { if (codeReader) codeReader.reset(); } catch (_) {}
      scannerRunning = false;

      scannerCard.style.display = 'none';
      toggleScannerBtn.textContent = 'üì∑ –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å';

      scannerStatus.textContent = '';
      scannerStatus.className = 'status';
    }
  </script>
</body>
</html>
