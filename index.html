<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–°–∫–ª–∞–¥ –ø–ª—ë–Ω–∫–∏</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 0;
      background: #f5f5f5;
      color: #222;
    }
    .container { max-width: 480px; margin: 0 auto; padding: 16px; }
    h1 { font-size: 20px; text-align: center; margin-bottom: 12px; }

    .card {
      background: #ffffff;
      border-radius: 14px;
      padding: 12px 14px;
      margin-bottom: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }

    label { display: block; font-size: 13px; margin-bottom: 4px; color: #555; }

    input, button {
      width: 100%;
      box-sizing: border-box;
      font-size: 16px;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid #ccc;
    }

    input { background: #fafafa; }

    button {
      margin-top: 8px;
      font-weight: 600;
      border: none;
      cursor: pointer;
    }

    .btn-primary { background: #007bff; color: #fff; }
    .btn-danger  { background: #dc3545; color: #fff; }
    .btn-secondary { background: #e0e0e0; color: #333; }
    .btn-outline { background: #fff; border: 1px solid #007bff; color: #007bff; }

    .small-text { font-size: 12px; color: #777; margin-top: 4px; }

    .suggestions {
      margin-top: 6px;
      max-height: 220px;
      overflow-y: auto;
      border-radius: 10px;
      border: 1px solid #ddd;
      background: #fff;
    }

    .suggestion-item {
      padding: 8px 10px;
      border-bottom: 1px solid #f0f0f0;
      font-size: 13px;
    }
    .suggestion-item:last-child { border-bottom: none; }
    .suggestion-item strong { display: block; font-size: 14px; }
    .suggestion-item span { color: #666; }
    .suggestion-item:active { background: #f1f1f1; }

    .status { font-size: 13px; margin-top: 6px; min-height: 18px; }
    .status.ok { color: #2e7d32; }
    .status.error { color: #c62828; }

    /* –°–∫–∞–Ω–µ—Ä */
    #scannerCard { padding: 10px 12px; }
    #scannerContainer {
      position: relative;
      width: 100%;
      height: 220px;
      background: #000;
      border-radius: 12px;
      overflow: hidden;
      margin-top: 8px;
    }
    #video { width: 100%; height: 100%; object-fit: cover; }

    .scanner-overlay-line {
      position: absolute;
      top: 50%;
      left: 10%;
      right: 10%;
      height: 2px;
      transform: translateY(-50%);
      background: rgba(255, 0, 0, 0.8);
      box-shadow: 0 0 8px rgba(255,0,0,0.9);
    }

    .scanner-hint {
      font-size: 12px;
      color: #eee;
      position: absolute;
      bottom: 6px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.45);
      padding: 4px 8px;
      border-radius: 8px;
    }

    /* –ú–æ–¥–∞–ª–∫–∞ */
    .modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.4);
      z-index: 999;
      align-items: center;
      justify-content: center;
    }
    .modal-content {
      background: #fff;
      border-radius: 16px;
      padding: 16px;
      max-width: 320px;
      width: 90%;
      box-shadow: 0 4px 16px rgba(0,0,0,0.25);
    }
    .modal-text { font-size: 14px; margin-bottom: 12px; white-space: pre-line; }
    .modal-buttons { display: flex; gap: 8px; margin-top: 4px; }
    .modal-buttons button { flex: 1; }
  </style>
</head>
<body>
  <div class="container">
    <h1>–°–∫–ª–∞–¥ –ø–ª—ë–Ω–∫–∏</h1>

    <!-- –ü–æ–∏—Å–∫ –ø–æ —à—Ç—Ä–∏—Ö–∫–æ–¥—É / –ø–æ—Å–ª–µ–¥–Ω–∏–º —Ü–∏—Ñ—Ä–∞–º -->
    <div class="card">
      <label for="barcodeInput">–®—Ç—Ä–∏—Ö–∫–æ–¥ (–º–æ–∂–Ω–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Ü–∏—Ñ—Ä—ã)</label>
      <input id="barcodeInput" type="tel" inputmode="numeric" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, 35924" />
      <div class="small-text">–ú–æ–∂–Ω–æ –≤–≤–æ–¥–∏—Ç—å –≤—Ä—É—á–Ω—É—é –∏–ª–∏ –æ—Ç—Å–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –∫–∞–º–µ—Ä–æ–π.</div>
      <button id="toggleScannerBtn" class="btn-outline">üì∑ –í–∫–ª—é—á–∏—Ç—å —Å–∫–∞–Ω–µ—Ä</button>
      <div id="suggestions" class="suggestions" style="display:none;"></div>
    </div>

    <!-- –°–∫–∞–Ω–µ—Ä -->
    <div class="card" id="scannerCard" style="display:none;">
      <div class="small-text">–ù–∞–≤–µ–¥–∏ –∫–∞–º–µ—Ä—É –Ω–∞ —à—Ç—Ä–∏—Ö–∫–æ–¥. –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Å–∫–∞–Ω–µ—Ä —Å–∞–º –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è.</div>
      <div id="scannerContainer">
        <video id="video" muted autoplay playsinline></video>
        <div class="scanner-overlay-line"></div>
        <div class="scanner-hint">–ù–∞–≤–µ–¥–∏ —à—Ç—Ä–∏—Ö–∫–æ–¥ –≤ –∫—Ä–∞—Å–Ω—É—é –ª–∏–Ω–∏—é</div>
      </div>
    </div>

    <!-- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ / –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ -->
    <div class="card">
      <label for="addBarcode">–®—Ç—Ä–∏—Ö–∫–æ–¥</label>
      <input id="addBarcode" type="tel" inputmode="numeric" placeholder="–ü–æ–ª–Ω—ã–π —à—Ç—Ä–∏—Ö–∫–æ–¥" />

      <label for="addName" style="margin-top:8px;">–ù–∞–∑–≤–∞–Ω–∏–µ –ø–ª—ë–Ω–∫–∏</label>
      <input id="addName" type="text" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, Hydrogel iPhone 11" />

      <div class="row">
        <div>
          <label for="addQty">–ö–æ–ª-–≤–æ</label>
          <input id="addQty" type="number" min="1" value="1" />
        </div>
      </div>

      <button id="addBtn" class="btn-primary">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å / —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      <div class="small-text" id="addHint"></div>
      <div class="status" id="addStatus"></div>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª–∫–∞ +1 / -1 -->
  <div class="modal" id="existingModal">
    <div class="modal-content">
      <div class="modal-text" id="existingText"></div>
      <div class="modal-buttons">
        <button id="modalAdd1" class="btn-primary">+1</button>
        <button id="modalDel1" class="btn-danger">-1</button>
      </div>
      <button id="modalCancel" class="btn-secondary" style="margin-top:8px;">–û—Ç–º–µ–Ω–∞</button>
    </div>
  </div>

  <!-- ZXing -->
  <script src="https://unpkg.com/@zxing/library@latest"></script>
  <script>
    // –í–°–¢–ê–í–¨ –°–Æ–î–ê –°–í–û–ô URL –ò–ó APPS SCRIPT
    const API_URL = 'https://script.google.com/macros/s/AKfycbyo6uual9eT8NbBZFPFPyj8k6lpCuW2n95qMZQx_L4VV4i5AHlT7z8vb6VsvY1TPDRYvA/exec';

    const barcodeInput   = document.getElementById('barcodeInput');
    const suggestionsEl  = document.getElementById('suggestions');

    const addBarcode     = document.getElementById('addBarcode');
    const addName        = document.getElementById('addName');
    const addQty         = document.getElementById('addQty');
    const addBtn         = document.getElementById('addBtn');
    const addStatus      = document.getElementById('addStatus');
    const addHint        = document.getElementById('addHint');

    const toggleScannerBtn = document.getElementById('toggleScannerBtn');
    const scannerCard      = document.getElementById('scannerCard');

    const existingModal = document.getElementById('existingModal');
    const existingText  = document.getElementById('existingText');
    const modalAdd1     = document.getElementById('modalAdd1');
    const modalDel1     = document.getElementById('modalDel1');
    const modalCancel   = document.getElementById('modalCancel');

    let currentItem = null;
    let searchTimeout = null;
    let scannerActive = false;
    let codeReader = null;
    let modalCurrentItem = null;

    /* ===== JSONP-–æ–±—ë—Ä—Ç–∫–∞ (–±–µ–∑ CORS –ø—Ä–æ–±–ª–µ–º) ===== */
    function jsonpCall(params) {
      return new Promise((resolve, reject) => {
        const callbackName = 'jsonp_cb_' + Date.now() + '_' + Math.random().toString(16).slice(2);

        params = Object.assign({}, params, { callback: callbackName });

        const query = Object.keys(params)
          .map(k => encodeURIComponent(k) + '=' + encodeURIComponent(params[k]))
          .join('&');

        const script = document.createElement('script');
        script.src = API_URL + '?' + query;
        script.async = true;

        let timeout = setTimeout(() => {
          cleanup();
          reject(new Error('JSONP timeout'));
        }, 10000);

        function cleanup() {
          if (script.parentNode) script.parentNode.removeChild(script);
          clearTimeout(timeout);
          delete window[callbackName];
        }

        window[callbackName] = (data) => {
          cleanup();
          resolve(data);
        };

        script.onerror = () => {
          cleanup();
          reject(new Error('JSONP script error'));
        };

        document.body.appendChild(script);
      });
    }

    /* ===== –ü–æ–∏—Å–∫ –ø–æ –≤–µ—Ä—Ö–Ω–µ–º—É –ø–æ–ª—é (—á–∞—Å—Ç—å —à—Ç—Ä–∏—Ö–∫–æ–¥–∞) ===== */
    barcodeInput.addEventListener('input', () => {
      const q = barcodeInput.value.trim();
      if (searchTimeout) clearTimeout(searchTimeout);
      if (!q) {
        suggestionsEl.style.display = 'none';
        suggestionsEl.innerHTML = '';
        currentItem = null;
        return;
      }
      // —á—É—Ç—å —É—Å–∫–æ—Ä–∏–ª–∏ ‚Äî –º–∞–ª–µ–Ω—å–∫–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞
      searchTimeout = setTimeout(() => searchItems(q), 120);
    });

    function searchItems(query) {
      jsonpCall({ action: 'list', query })
        .then(data => {
          const items = data.items || [];
          if (!items.length) {
            suggestionsEl.style.display = 'none';
            suggestionsEl.innerHTML = '';
            return;
          }

          suggestionsEl.innerHTML = '';
          items.forEach(item => {
            const div = document.createElement('div');
            div.className = 'suggestion-item';
            div.innerHTML = `
              <strong>${item.name}</strong>
              <span>–®–ö: ${item.barcode} ‚Ä¢ –û—Å—Ç–∞—Ç–æ–∫: ${item.quantity}</span>
            `;
            div.addEventListener('click', () => selectItem(item));
            suggestionsEl.appendChild(div);
          });
          suggestionsEl.style.display = 'block';
        })
        .catch(err => {
          console.error('searchItems error:', err);
        });
    }

    function selectItem(item) {
      currentItem = item;
      // –ø—Ä–æ—Å—Ç–æ –ø–æ–¥—Å—Ç–∞–≤–ª—è–µ–º –≤ —Ñ–æ—Ä–º—É, –±–µ–∑ –∫–∞—Ä—Ç–æ—á–∫–∏
      addBarcode.value = item.barcode;
      addName.value    = item.name;
      addHint.textContent = '';
      suggestionsEl.style.display = 'none';
    }

    /* ===== –ö–Ω–æ–ø–∫–∞ "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å / —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å" ===== */
    addBtn.addEventListener('click', () => {
      const barcode = addBarcode.value.trim();
      const name    = addName.value.trim();
      const qty     = Number(addQty.value || 1);

      addStatus.textContent = '';
      addStatus.className = 'status';
      addHint.textContent = '';

      if (!barcode) {
        addStatus.textContent = '–í–≤–µ–¥–∏—Ç–µ —à—Ç—Ä–∏—Ö–∫–æ–¥';
        addStatus.className = 'status error';
        return;
      }

      addStatus.textContent = '–ü—Ä–æ–≤–µ—Ä—è–µ–º —à—Ç—Ä–∏—Ö–∫–æ–¥ –≤ –±–∞–∑–µ...';
      addStatus.className = 'status';

      jsonpCall({ action: 'list', query: barcode })
        .then(data => {
          const items = Array.isArray(data.items) ? data.items : [];
          const exact = items.find(i => String(i.barcode) === barcode);

          if (exact) {
            // –Ω–∞–π–¥–µ–Ω —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Ç–æ–≤–∞—Ä ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ popup
            addStatus.textContent = '';
            showExistingModal(exact);
          } else {
            // –Ω–µ—Ç –≤ –±–∞–∑–µ ‚Äî –¥–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π
            handleAddNew(barcode, name, qty);
          }
        })
        .catch(err => {
          console.error('check barcode error:', err);
          // –¥–∞–∂–µ –µ—Å–ª–∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–µ —É–¥–∞–ª–∞—Å—å ‚Äî –¥–∞—ë–º –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –¥–æ–±–∞–≤–∏—Ç—å
          handleAddNew(barcode, name, qty, true);
        });
    });

    function handleAddNew(barcode, name, qty, fromError = false) {
      addStatus.textContent = '';
      if (!name || qty <= 0) {
        addHint.textContent = fromError
          ? '–ù–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ –±–∞–∑–µ. –í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –µ—â—ë —Ä–∞–∑, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä.'
          : '–¢–∞–∫–æ–≥–æ —à—Ç—Ä–∏—Ö–∫–æ–¥–∞ –Ω–µ—Ç –≤ –±–∞–∑–µ. –í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –µ—â—ë —Ä–∞–∑, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä.';
        return;
      }
      doAdd(barcode, name, qty, (data) => {
        const newQty = data && typeof data.newQty === 'number' ? data.newQty : qty;
        addHint.textContent = `–ù–æ–≤—ã–π —Ç–æ–≤–∞—Ä –¥–æ–±–∞–≤–ª–µ–Ω –≤ –±–∞–∑—É. –°–µ–π—á–∞—Å –Ω–∞ —Å–∫–ª–∞–¥–µ: ${newQty} —à—Ç.`;
      });
    }

    function doAdd(barcode, name, qty, onDone) {
      addStatus.textContent = '–°–æ—Ö—Ä–∞–Ω—è–µ–º...';
      addStatus.className = 'status';

      jsonpCall({ action: 'add', barcode, name, quantity: qty })
        .then(data => {
          if (data.error) {
            addStatus.textContent = '–û—à–∏–±–∫–∞: ' + (data.message || data.error);
            addStatus.className = 'status error';
          } else {
            addStatus.textContent = '–£—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ';
            addStatus.className = 'status ok';
            if (typeof onDone === 'function') onDone(data);
          }
        })
        .catch(err => {
          console.error('add error:', err);
          addStatus.textContent = '–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏';
          addStatus.className = 'status error';
        });
    }

    /* ===== –ú–æ–¥–∞–ª–∫–∞ +1 / -1 ===== */
    function showExistingModal(item) {
      modalCurrentItem = item;
      existingText.textContent =
        `–í –±–∞–∑–µ ${item.quantity} —à—Ç. —Ç–æ–≤–∞—Ä–∞:\n¬´${item.name}¬ª.\n–ß—Ç–æ –≤—ã —Ö–æ—Ç–∏—Ç–µ —Å–¥–µ–ª–∞—Ç—å?`;
      existingModal.style.display = 'flex';
    }

    function closeExistingModal() {
      existingModal.style.display = 'none';
      modalCurrentItem = null;
    }

    modalCancel.addEventListener('click', () => closeExistingModal());

    // +1 –∏–∑ popup
    modalAdd1.addEventListener('click', () => {
      if (!modalCurrentItem) return;

      const code = modalCurrentItem.barcode;
      const name = modalCurrentItem.name;
      const currentQty = modalCurrentItem.quantity;

      doAdd(code, name, 1, (data) => {
        closeExistingModal();
        const newQty = data && typeof data.newQty === 'number'
          ? data.newQty
          : currentQty + 1;
        addStatus.textContent = `–î–æ–±–∞–≤–ª–µ–Ω–æ 1 —à—Ç. –ù–æ–≤–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ: ${newQty}`;
        addStatus.className = 'status ok';
      });
    });

    // -1 –∏–∑ popup
    modalDel1.addEventListener('click', () => {
      if (!modalCurrentItem) return;

      const code = modalCurrentItem.barcode;
      const currentQty = modalCurrentItem.quantity;

      addStatus.textContent = '–°–ø–∏—Å—ã–≤–∞–µ–º 1 —à—Ç...';
      addStatus.className = 'status';

      jsonpCall({ action: 'delete', barcode: code, quantity: 1 })
        .then(data => {
          closeExistingModal();
          if (data.error) {
            addStatus.textContent = '–û—à–∏–±–∫–∞: ' + (data.message || data.error);
            addStatus.className = 'status error';
          } else {
            const newQty = data && typeof data.newQty === 'number'
              ? data.newQty
              : Math.max(currentQty - 1, 0);
            addStatus.textContent = `–°–ø–∏—Å–∞–Ω–æ 1 —à—Ç. –ù–æ–≤–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ: ${newQty}`;
            addStatus.className = 'status ok';
          }
        })
        .catch(err => {
          console.error('delete modal error:', err);
          addStatus.textContent = '–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–ø–∏—Å–∞–Ω–∏–∏';
          addStatus.className = 'status error';
          closeExistingModal();
        });
    });

    existingModal.addEventListener('click', (e) => {
      if (e.target === existingModal) closeExistingModal();
    });

    /* ===== –°–∫–∞–Ω–µ—Ä ZXing ===== */
    toggleScannerBtn.addEventListener('click', () => {
      if (scannerActive) {
        stopScanner();
      } else {
        startScanner();
      }
    });

    function startScanner() {
      if (scannerActive) return;

      scannerCard.style.display = 'block';
      toggleScannerBtn.textContent = '‚úñ –í—ã–∫–ª—é—á–∏—Ç—å —Å–∫–∞–Ω–µ—Ä';

      if (!codeReader) {
        codeReader = new ZXing.BrowserMultiFormatReader();
      }

      codeReader
        .decodeFromVideoDevice(
          null,
          'video',
          (result, err) => {
            if (result) {
              const code = result.getText();
              stopScanner();

              barcodeInput.value = code;
              addBarcode.value   = code;

              addHint.textContent = '';
              addStatus.textContent = '';

              searchItems(code); // –±—ã—Å—Ç—Ä—ã–π –ø–æ–∏—Å–∫ –ø–æ –ø–æ–ª–Ω–æ–º—É –±–∞—Ä–∫–æ–¥—É
            }
          }
        )
        .then(() => {
          scannerActive = true;
        })
        .catch(err => {
          console.error('scanner error:', err);
          alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –∫–∞–º–µ—Ä—É. –û—Ç–∫—Ä–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø–æ HTTPS –∏ —Ä–∞–∑—Ä–µ—à–∏ –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ.');
          scannerCard.style.display = 'none';
          toggleScannerBtn.textContent = 'üì∑ –í–∫–ª—é—á–∏—Ç—å —Å–∫–∞–Ω–µ—Ä';
          scannerActive = false;
        });
    }

    function stopScanner() {
      if (!scannerActive) return;
      if (codeReader) {
        codeReader.reset();
      }
      scannerActive = false;
      scannerCard.style.display = 'none';
      toggleScannerBtn.textContent = 'üì∑ –í–∫–ª—é—á–∏—Ç—å —Å–∫–∞–Ω–µ—Ä';
    }
  </script>
</body>
</html>
