<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–°–∫–ª–∞–¥ –ø–ª—ë–Ω–∫–∏</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 0;
      background: #f5f5f5;
      color: #222;
    }
    .container { max-width: 480px; margin: 0 auto; padding: 16px; }
    h1 { font-size: 20px; text-align: center; margin-bottom: 12px; }

    .card {
      background: #ffffff;
      border-radius: 14px;
      padding: 12px 14px;
      margin-bottom: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }

    label { display: block; font-size: 13px; margin-bottom: 4px; color: #555; }

    input, button, select {
      width: 100%;
      box-sizing: border-box;
      font-size: 16px;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid #ccc;
    }

    input, select { background: #fafafa; }

    button {
      margin-top: 8px;
      font-weight: 600;
      border: none;
      cursor: pointer;
    }

    .btn-primary { background: #007bff; color: #fff; }
    .btn-danger  { background: #dc3545; color: #fff; }
    .btn-secondary { background: #e0e0e0; color: #333; }
    .btn-outline { background: #fff; border: 1px solid #007bff; color: #007bff; }

    .small-text { font-size: 12px; color: #777; margin-top: 4px; }

    .suggestions {
      margin-top: 6px;
      max-height: 220px;
      overflow-y: auto;
      border-radius: 10px;
      border: 1px solid #ddd;
      background: #fff;
    }

    .suggestion-item {
      padding: 8px 10px;
      border-bottom: 1px solid #f0f0f0;
      font-size: 13px;
    }
    .suggestion-item:last-child { border-bottom: none; }
    .suggestion-item strong { display: block; font-size: 14px; }
    .suggestion-item span { color: #666; }
    .suggestion-item:active { background: #f1f1f1; }

    .status { font-size: 13px; margin-top: 6px; min-height: 18px; }
    .status.ok { color: #2e7d32; }
    .status.error { color: #c62828; }

    /* –°–∫–∞–Ω–µ—Ä */
    #scannerCard { padding: 10px 12px; }
    #scannerContainer {
      position: relative;
      width: 100%;
      height: 220px;
      background: #000;
      border-radius: 12px;
      overflow: hidden;
      margin-top: 8px;
    }
    #video { width: 100%; height: 100%; object-fit: cover; }

    .scanner-overlay-line {
      position: absolute;
      top: 50%;
      left: 10%;
      right: 10%;
      height: 2px;
      transform: translateY(-50%);
      background: rgba(255, 0, 0, 0.8);
      box-shadow: 0 0 8px rgba(255,0,0,0.9);
    }

    .scanner-hint {
      font-size: 12px;
      color: #eee;
      position: absolute;
      bottom: 6px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.45);
      padding: 4px 8px;
      border-radius: 8px;
    }

    /* –ú–æ–¥–∞–ª–∫–∞ */
    .modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.4);
      z-index: 999;
      align-items: center;
      justify-content: center;
    }
    .modal-content {
      background: #fff;
      border-radius: 16px;
      padding: 16px;
      max-width: 340px;
      width: 92%;
      box-shadow: 0 4px 16px rgba(0,0,0,0.25);
    }
    .modal-text { font-size: 14px; margin-bottom: 12px; white-space: pre-line; }
    .modal-buttons { display: flex; gap: 8px; margin-top: 4px; }
    .modal-buttons button { flex: 1; }
  </style>
</head>
<body>
  <div class="container">
    <h1>–°–∫–ª–∞–¥ –ø–ª—ë–Ω–∫–∏</h1>

    <!-- –ü–æ–∏—Å–∫ –ø–æ —à—Ç—Ä–∏—Ö–∫–æ–¥—É / –ø–æ—Å–ª–µ–¥–Ω–∏–º —Ü–∏—Ñ—Ä–∞–º -->
    <div class="card">
      <label for="barcodeInput">–®—Ç—Ä–∏—Ö–∫–æ–¥ (–º–æ–∂–Ω–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Ü–∏—Ñ—Ä—ã)</label>
      <input id="barcodeInput" type="tel" inputmode="numeric" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, 35924" />
      <div class="small-text">–ú–æ–∂–Ω–æ –≤–≤–æ–¥–∏—Ç—å –≤—Ä—É—á–Ω—É—é –∏–ª–∏ –æ—Ç—Å–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –∫–∞–º–µ—Ä–æ–π.</div>
      <button id="toggleScannerBtn" class="btn-outline">üì∑ –í–∫–ª—é—á–∏—Ç—å —Å–∫–∞–Ω–µ—Ä</button>
      <div id="suggestions" class="suggestions" style="display:none;"></div>
    </div>

    <!-- –°–∫–∞–Ω–µ—Ä -->
    <div class="card" id="scannerCard" style="display:none;">
      <div class="small-text">–ù–∞–≤–µ–¥–∏ –∫–∞–º–µ—Ä—É –Ω–∞ —à—Ç—Ä–∏—Ö–∫–æ–¥. –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Å–∫–∞–Ω–µ—Ä —Å–∞–º –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è.</div>

      <!-- –í—ã–±–æ—Ä –∫–∞–º–µ—Ä—ã (–≤–∞–∂–Ω–æ –¥–ª—è Android) -->
      <div style="display:flex; gap:8px; margin-top:8px;">
        <select id="cameraSelect" style="flex:1;"></select>
        <button id="switchCameraBtn" class="btn-secondary" style="width:auto; padding:10px 12px; margin-top:0;">üîÅ</button>
      </div>
      <div class="small-text">–ï—Å–ª–∏ –ø–ª–æ—Ö–æ —Å—á–∏—Ç—ã–≤–∞–µ—Ç ‚Äî –≤—ã–±–µ—Ä–∏ –¥—Ä—É–≥—É—é –∫–∞–º–µ—Ä—É (–Ω–µ —à–∏—Ä–∏–∫/–Ω–µ —Ç–µ–ª–µ–≤–∏–∫).</div>

      <div id="scannerContainer">
        <video id="video" muted autoplay playsinline></video>
        <div class="scanner-overlay-line"></div>
        <div class="scanner-hint">–ù–∞–≤–µ–¥–∏ —à—Ç—Ä–∏—Ö–∫–æ–¥ –≤ –∫—Ä–∞—Å–Ω—É—é –ª–∏–Ω–∏—é</div>
      </div>
    </div>

    <!-- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ / –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ -->
    <div class="card">
      <label for="addBarcode">–®—Ç—Ä–∏—Ö–∫–æ–¥</label>
      <input id="addBarcode" type="tel" inputmode="numeric" placeholder="–ü–æ–ª–Ω—ã–π —à—Ç—Ä–∏—Ö–∫–æ–¥" />

      <label for="addName" style="margin-top:8px;">–ù–∞–∑–≤–∞–Ω–∏–µ –ø–ª—ë–Ω–∫–∏</label>
      <input id="addName" type="text" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, Hydrogel iPhone 11" />

      <label for="addQty" style="margin-top:8px;">–ö–æ–ª-–≤–æ</label>
      <input id="addQty" type="number" min="1" value="1" />

      <button id="addBtn" class="btn-primary">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å / —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      <div class="small-text" id="addHint"></div>
      <div class="status" id="addStatus"></div>
    </div>
  </div>

  <!-- POPUP: –µ—Å–ª–∏ —Ç–æ–≤–∞—Ä –Ω–∞–π–¥–µ–Ω ‚Äî —Ç–æ–ª—å–∫–æ popup -->
  <div class="modal" id="existingModal">
    <div class="modal-content">
      <div class="modal-text" id="existingText"></div>
      <div class="modal-buttons">
        <button id="modalAdd1" class="btn-primary">+1</button>
        <button id="modalDel1" class="btn-danger">-1</button>
      </div>
      <button id="modalCancel" class="btn-secondary" style="margin-top:8px;">–û—Ç–º–µ–Ω–∞</button>
    </div>
  </div>

  <!-- ZXing -->
  <script src="https://unpkg.com/@zxing/library@latest"></script>
  <script>
    // 1) –í–°–¢–ê–í–¨ –°–Æ–î–ê –°–í–û–ô URL –ò–ó APPS SCRIPT (web app /exec)
    const API_URL = 'https://script.google.com/macros/s/AKfycbyo6uual9eT8NbBZFPFPyj8k6lpCuW2n95qMZQx_L4VV4i5AHlT7z8vb6VsvY1TPDRYvA/exec';

    const barcodeInput   = document.getElementById('barcodeInput');
    const suggestionsEl  = document.getElementById('suggestions');

    const addBarcode     = document.getElementById('addBarcode');
    const addName        = document.getElementById('addName');
    const addQty         = document.getElementById('addQty');
    const addBtn         = document.getElementById('addBtn');
    const addStatus      = document.getElementById('addStatus');
    const addHint        = document.getElementById('addHint');

    const toggleScannerBtn = document.getElementById('toggleScannerBtn');
    const scannerCard      = document.getElementById('scannerCard');

    const existingModal = document.getElementById('existingModal');
    const existingText  = document.getElementById('existingText');
    const modalAdd1     = document.getElementById('modalAdd1');
    const modalDel1     = document.getElementById('modalDel1');
    const modalCancel   = document.getElementById('modalCancel');

    const cameraSelect = document.getElementById('cameraSelect');
    const switchCameraBtn = document.getElementById('switchCameraBtn');

    let searchTimeout = null;

    let scannerActive = false;
    let codeReader = null;

    let modalCurrentItem = null;

    let selectedDeviceId = null;
    let availableCameras = [];
    const lastUsedDeviceIdKey = 'moscrm_last_camera_id';

    /* ===== JSONP (–±–µ–∑ CORS) ===== */
    function jsonpCall(params) {
      return new Promise((resolve, reject) => {
        const callbackName = 'jsonp_cb_' + Date.now() + '_' + Math.random().toString(16).slice(2);
        params = Object.assign({}, params, { callback: callbackName });

        const query = Object.keys(params)
          .map(k => encodeURIComponent(k) + '=' + encodeURIComponent(params[k]))
          .join('&');

        const script = document.createElement('script');
        script.src = API_URL + '?' + query;
        script.async = true;

        const timeout = setTimeout(() => {
          cleanup();
          reject(new Error('JSONP timeout'));
        }, 10000);

        function cleanup() {
          if (script.parentNode) script.parentNode.removeChild(script);
          clearTimeout(timeout);
          delete window[callbackName];
        }

        window[callbackName] = (data) => { cleanup(); resolve(data); };
        script.onerror = () => { cleanup(); reject(new Error('JSONP script error')); };

        document.body.appendChild(script);
      });
    }

    /* ===== –ü–æ–∏—Å–∫ (—É—Å–∫–æ—Ä–µ–Ω–æ) ===== */
    barcodeInput.addEventListener('input', () => {
      const q = barcodeInput.value.trim();
      if (searchTimeout) clearTimeout(searchTimeout);
      if (!q) {
        suggestionsEl.style.display = 'none';
        suggestionsEl.innerHTML = '';
        return;
      }
      searchTimeout = setTimeout(() => searchItems(q), 80);
    });

    function searchItems(query) {
      jsonpCall({ action: 'list', query })
        .then(data => {
          const items = data.items || [];
          if (!items.length) {
            suggestionsEl.style.display = 'none';
            suggestionsEl.innerHTML = '';
            return;
          }

          suggestionsEl.innerHTML = '';
          items.forEach(item => {
            const div = document.createElement('div');
            div.className = 'suggestion-item';
            div.innerHTML = `
              <strong>${item.name}</strong>
              <span>–®–ö: ${item.barcode} ‚Ä¢ –û—Å—Ç–∞—Ç–æ–∫: ${item.quantity}</span>
            `;
            div.addEventListener('click', () => {
              // –ø–æ–¥—Å—Ç–∞–≤–ª—è–µ–º –≤ —Ñ–æ—Ä–º—É –∏ –ø—Ä—è—á–µ–º —Å–ø–∏—Å–æ–∫
              addBarcode.value = item.barcode;
              addName.value = item.name;
              addHint.textContent = '';
              suggestionsEl.style.display = 'none';
            });
            suggestionsEl.appendChild(div);
          });
          suggestionsEl.style.display = 'block';
        })
        .catch(err => console.error('searchItems error:', err));
    }

    /* ===== –ö–Ω–æ–ø–∫–∞ "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å / —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å" ===== */
    addBtn.addEventListener('click', () => {
      const barcode = addBarcode.value.trim();
      const name = addName.value.trim();
      const qty = Number(addQty.value || 1);

      addStatus.textContent = '';
      addStatus.className = 'status';
      addHint.textContent = '';

      if (!barcode) {
        addStatus.textContent = '–í–≤–µ–¥–∏—Ç–µ —à—Ç—Ä–∏—Ö–∫–æ–¥';
        addStatus.className = 'status error';
        return;
      }

      addStatus.textContent = '–ü—Ä–æ–≤–µ—Ä—è–µ–º —à—Ç—Ä–∏—Ö–∫–æ–¥ –≤ –±–∞–∑–µ...';
      addStatus.className = 'status';

      jsonpCall({ action: 'list', query: barcode })
        .then(data => {
          const items = Array.isArray(data.items) ? data.items : [];
          const exact = items.find(i => String(i.barcode) === barcode);

          if (exact) {
            addStatus.textContent = '';
            showExistingModal(exact);
          } else {
            handleAddNew(barcode, name, qty);
          }
        })
        .catch(err => {
          console.error('check barcode error:', err);
          handleAddNew(barcode, name, qty, true);
        });
    });

    function handleAddNew(barcode, name, qty, fromError = false) {
      addStatus.textContent = '';
      if (!name || qty <= 0) {
        addHint.textContent = fromError
          ? '–ù–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ –±–∞–∑–µ. –í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –µ—â—ë —Ä–∞–∑, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä.'
          : '–¢–∞–∫–æ–≥–æ —à—Ç—Ä–∏—Ö–∫–æ–¥–∞ –Ω–µ—Ç –≤ –±–∞–∑–µ. –í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –µ—â—ë —Ä–∞–∑, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä.';
        return;
      }
      doAdd(barcode, name, qty, (data) => {
        const newQty = data && typeof data.newQty === 'number' ? data.newQty : qty;
        addStatus.textContent = `–î–æ–±–∞–≤–ª–µ–Ω–æ. –°–µ–π—á–∞—Å –Ω–∞ —Å–∫–ª–∞–¥–µ: ${newQty}`;
        addStatus.className = 'status ok';
      });
    }

    function doAdd(barcode, name, qty, onDone) {
      addStatus.textContent = '–°–æ—Ö—Ä–∞–Ω—è–µ–º...';
      addStatus.className = 'status';

      jsonpCall({ action: 'add', barcode, name, quantity: qty })
        .then(data => {
          if (data.error) {
            addStatus.textContent = '–û—à–∏–±–∫–∞: ' + (data.message || data.error);
            addStatus.className = 'status error';
          } else {
            if (typeof onDone === 'function') onDone(data);
          }
        })
        .catch(err => {
          console.error('add error:', err);
          addStatus.textContent = '–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏';
          addStatus.className = 'status error';
        });
    }

    function doDelete(barcode, qty, onDone) {
      addStatus.textContent = `–°–ø–∏—Å—ã–≤–∞–µ–º ${qty}...`;
      addStatus.className = 'status';

      jsonpCall({ action: 'delete', barcode, quantity: qty })
        .then(data => {
          if (data.error) {
            addStatus.textContent = '–û—à–∏–±–∫–∞: ' + (data.message || data.error);
            addStatus.className = 'status error';
          } else {
            if (typeof onDone === 'function') onDone(data);
          }
        })
        .catch(err => {
          console.error('delete error:', err);
          addStatus.textContent = '–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–ø–∏—Å–∞–Ω–∏–∏';
          addStatus.className = 'status error';
        });
    }

    /* ===== POPUP +1 / -1 ===== */
    function showExistingModal(item) {
      modalCurrentItem = item;
      existingText.textContent =
        `–í –±–∞–∑–µ ${item.quantity} —à—Ç. —Ç–æ–≤–∞—Ä–∞:\n¬´${item.name}¬ª.\n–ß—Ç–æ –≤—ã —Ö–æ—Ç–∏—Ç–µ —Å–¥–µ–ª–∞—Ç—å?`;
      existingModal.style.display = 'flex';
    }

    function closeExistingModal() {
      existingModal.style.display = 'none';
      modalCurrentItem = null;
    }

    modalCancel.addEventListener('click', closeExistingModal);
    existingModal.addEventListener('click', (e) => { if (e.target === existingModal) closeExistingModal(); });

    modalAdd1.addEventListener('click', () => {
      if (!modalCurrentItem) return;

      const code = modalCurrentItem.barcode;
      const name = modalCurrentItem.name;
      const oldQty = Number(modalCurrentItem.quantity || 0);

      doAdd(code, name, 1, (data) => {
        closeExistingModal();
        const newQty = (data && typeof data.newQty === 'number') ? data.newQty : (oldQty + 1);
        addStatus.textContent = `–î–æ–±–∞–≤–ª–µ–Ω–æ 1 —à—Ç. –ù–æ–≤–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ: ${newQty}`;
        addStatus.className = 'status ok';
      });
    });

    modalDel1.addEventListener('click', () => {
      if (!modalCurrentItem) return;

      const code = modalCurrentItem.barcode;
      const oldQty = Number(modalCurrentItem.quantity || 0);

      doDelete(code, 1, (data) => {
        closeExistingModal();
        const newQty = (data && typeof data.newQty === 'number') ? data.newQty : Math.max(oldQty - 1, 0);
        addStatus.textContent = `–°–ø–∏—Å–∞–Ω–æ 1 —à—Ç. –ù–æ–≤–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ: ${newQty}`;
        addStatus.className = 'status ok';
      });
    });

    /* ===== –°–∫–∞–Ω–µ—Ä ZXing: –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ Android-–∫–∞–º–µ—Ä ===== */
    function scoreCamera_(label) {
      const s = (label || '').toLowerCase();
      let score = 0;

      if (s.includes('back') || s.includes('rear') || s.includes('environment')) score += 50;
      if (s.includes('main')) score += 30;
      if (s.includes('wide')) score += 20;

      if (s.includes('ultra') || s.includes('0.5') || s.includes('0,5')) score -= 25;
      if (s.includes('tele') || s.includes('zoom') || s.includes('2x') || s.includes('3x')) score -= 35;

      if (s.includes('front') || s.includes('user')) score -= 100;

      return score;
    }

    async function loadCameras_() {
      // —á—Ç–æ–±—ã –ø–æ—è–≤–∏–ª–∏—Å—å labels –Ω–∞ Android, –ø–æ–ø—Ä–æ–±—É–µ–º –∫—Ä–∞—Ç–∫–æ –∑–∞–ø—Ä–æ—Å–∏—Ç—å –¥–æ—Å—Ç—É–ø
      try {
        const tmpStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
        tmpStream.getTracks().forEach(t => t.stop());
      } catch (_) {}

      const devices = await ZXing.BrowserCodeReader.listVideoInputDevices();
      availableCameras = devices || [];

      cameraSelect.innerHTML = '';
      availableCameras.forEach((d, i) => {
        const opt = document.createElement('option');
        opt.value = d.deviceId;
        opt.textContent = d.label || `Camera ${i + 1}`;
        cameraSelect.appendChild(opt);
      });

      const showChooser = availableCameras.length > 1;
      cameraSelect.style.display = showChooser ? '' : 'none';
      switchCameraBtn.style.display = showChooser ? '' : 'none';

      const saved = localStorage.getItem(lastUsedDeviceIdKey);
      if (saved && availableCameras.some(c => c.deviceId === saved)) {
        selectedDeviceId = saved;
      } else {
        let best = null, bestScore = -9999;
        for (const cam of availableCameras) {
          const sc = scoreCamera_(cam.label);
          if (sc > bestScore) { bestScore = sc; best = cam; }
        }
        selectedDeviceId = best ? best.deviceId : (availableCameras[0] ? availableCameras[0].deviceId : null);
      }

      if (selectedDeviceId) cameraSelect.value = selectedDeviceId;
    }

    cameraSelect.addEventListener('change', () => {
      selectedDeviceId = cameraSelect.value || null;
      if (selectedDeviceId) localStorage.setItem(lastUsedDeviceIdKey, selectedDeviceId);
      if (scannerActive) { stopScanner(); startScanner(); }
    });

    switchCameraBtn.addEventListener('click', () => {
      if (!availableCameras.length) return;
      const idx = availableCameras.findIndex(c => c.deviceId === selectedDeviceId);
      const next = availableCameras[(idx + 1) % availableCameras.length];
      if (next) {
        selectedDeviceId = next.deviceId;
        cameraSelect.value = selectedDeviceId;
        localStorage.setItem(lastUsedDeviceIdKey, selectedDeviceId);
        if (scannerActive) { stopScanner(); startScanner(); }
      }
    });

    toggleScannerBtn.addEventListener('click', () => {
      if (scannerActive) stopScanner();
      else startScanner();
    });

    async function startScanner() {
      if (scannerActive) return;

      scannerCard.style.display = 'block';
      toggleScannerBtn.textContent = '‚úñ –í—ã–∫–ª—é—á–∏—Ç—å —Å–∫–∞–Ω–µ—Ä';

      if (!codeReader) codeReader = new ZXing.BrowserMultiFormatReader();

      try { await loadCameras_(); } catch (err) { console.error('loadCameras error:', err); }

      const deviceIdToUse = selectedDeviceId || null;

      try {
        await codeReader.decodeFromVideoDevice(
          deviceIdToUse,
          'video',
          (result, err) => {
            if (result) {
              const code = result.getText();
              stopScanner();

              barcodeInput.value = code;
              addBarcode.value = code;
              addHint.textContent = '';
              addStatus.textContent = '';

              // –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–¥—Å–∫–∞–∑–∫–∏/–ø–æ–∏—Å–∫
              searchItems(code);
            }
          }
        );
        scannerActive = true;
      } catch (err) {
        console.error('scanner error:', err);

        // fallback: –µ—Å–ª–∏ –≤—ã–±—Ä–∞–Ω–Ω–∞—è –∫–∞–º–µ—Ä–∞ –Ω–µ —Å—Ç–∞—Ä—Ç–∞–Ω—É–ª–∞ ‚Äî –ø—Ä–æ–±—É–µ–º –±–µ–∑ deviceId
        try {
          await codeReader.decodeFromVideoDevice(
            null,
            'video',
            (result) => {
              if (result) {
                const code = result.getText();
                stopScanner();
                barcodeInput.value = code;
                addBarcode.value = code;
                addHint.textContent = '';
                addStatus.textContent = '';
                searchItems(code);
              }
            }
          );
          scannerActive = true;
        } catch (err2) {
          console.error('scanner fallback error:', err2);
          alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –∫–∞–º–µ—Ä—É. –ü—Ä–æ–≤–µ—Ä—å HTTPS –∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –∫–∞–º–µ—Ä—ã.');
          scannerCard.style.display = 'none';
          toggleScannerBtn.textContent = 'üì∑ –í–∫–ª—é—á–∏—Ç—å —Å–∫–∞–Ω–µ—Ä';
          scannerActive = false;
        }
      }
    }

    function stopScanner() {
      try { if (codeReader) codeReader.reset(); } catch (_) {}
      scannerActive = false;
      scannerCard.style.display = 'none';
      toggleScannerBtn.textContent = 'üì∑ –í–∫–ª—é—á–∏—Ç—å —Å–∫–∞–Ω–µ—Ä';
    }
  </script>
</body>
</html>
